"use strict";var root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;!function(e){var t=function(n){var o=this;if(!t.isRecordingSupported())throw new Error("Recording is not supported in this browser");this.state="inactive",this.renderState="running",this.renderIdleCounter=0,this.eventTarget=e.document.createDocumentFragment(),this.audioContext=new e.AudioContext,this.monitorNode=this.audioContext.createGain(),this.config=n=n||{},this.config.command="init",this.config.bufferLength=n.bufferLength||4096,this.config.monitorGain=n.monitorGain||0,this.config.numberOfChannels=n.numberOfChannels||1,this.config.originalSampleRate=this.audioContext.sampleRate,this.config.encoderSampleRate=n.encoderSampleRate||48e3,this.config.encoderPath=n.encoderPath||"encoderWorker.min.js",this.config.decoderPath=n.decoderPath||"decoderWorker.min.js",this.config.streamPages=!0,this.config.rawPacket=n.rawPacket||!1,this.config.leaveStreamOpen=n.leaveStreamOpen||!1,this.config.maxBuffersPerPage=n.maxBuffersPerPage||40,this.config.encoderApplication=n.encoderApplication||2049,this.config.encoderFrameSize=n.encoderFrameSize||20,this.config.resampleQuality=n.resampleQuality||3,this.config.streamOptions=n.streamOptions||{optional:[],mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1}},this.setMonitorGain(this.config.monitorGain),this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.renderQueue=new Array,this.scriptProcessorNode.onaudioprocess=function(t){if(o.encodeBuffers(t.inputBuffer),o.renderQueue.length&&"running"===o.renderState){for(var n=o.renderQueue.shift(),i=0;i<t.outputBuffer.numberOfChannels;i++)t.outputBuffer.copyToChannel(n[i],i);o.eventTarget.dispatchEvent(new e.CustomEvent("rqupdate",{detail:o.renderQueue.length}))}else++o.renderIdleCounter,o.eventTarget.dispatchEvent(new e.CustomEvent("ridle",{detail:o.renderIdleCounter}))},this.decoder=new e.Worker(this.config.decoderPath),this.decoder.onmessage=function(t){null===t.data||(o.renderQueue.push(t.data),o.eventTarget.dispatchEvent(new e.CustomEvent("rqupdate",{detail:o.renderQueue.length})))},this.decoder.postMessage({command:"init",bufferLength:this.config.bufferLength,decoderSampleRate:this.config.encoderSampleRate,outputBufferSampleRate:this.audioContext.sampleRate,rawPacket:this.config.rawPacket})};t.isRecordingSupported=function(){return e.AudioContext&&e.navigator&&(e.navigator.getUserMedia||e.navigator.mediaDevices&&e.navigator.mediaDevices.getUserMedia)},t.prototype.addEventListener=function(e,t,n){this.eventTarget.addEventListener(e,t,n)},t.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(function(e){e.stop()}):this.stream.stop(),delete this.stream)},t.prototype.encodeBuffers=function(e){if("recording"===this.state){for(var t=[],n=0;n<e.numberOfChannels;n++)t[n]=e.getChannelData(n);this.encoder.postMessage({command:"encode",buffers:t})}},t.prototype.initStream=function(){var t=this,n=function(n){return t.stream=n,t.sourceNode=t.audioContext.createMediaStreamSource(n),t.sourceNode.connect(t.scriptProcessorNode),t.sourceNode.connect(t.monitorNode),t.eventTarget.dispatchEvent(new e.Event("streamReady")),n},o=function(n){t.eventTarget.dispatchEvent(new e.ErrorEvent("streamError",{error:n}))},i={audio:this.config.streamOptions};return this.stream?(this.eventTarget.dispatchEvent(new e.Event("streamReady")),e.Promise.resolve(this.stream)):e.navigator.mediaDevices&&e.navigator.mediaDevices.getUserMedia?e.navigator.mediaDevices.getUserMedia(i).then(n,o):e.navigator.getUserMedia?new e.Promise(function(t,n){e.navigator.getUserMedia(i,t,n)}).then(n,o):void 0},t.prototype.pause=function(){"recording"===this.state&&(this.state="paused",this.eventTarget.dispatchEvent(new e.Event("pause")))},t.prototype.removeEventListener=function(e,t,n){this.eventTarget.removeEventListener(e,t,n)},t.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.eventTarget.dispatchEvent(new e.Event("resume")))},t.prototype.setMonitorGain=function(e){this.monitorNode.gain.value=e},t.prototype.start=function(){if("inactive"===this.state&&this.stream){var t=this;this.encoder=new e.Worker(this.config.encoderPath),this.encoder.addEventListener("message",function(n){null===n.data?t.eventTarget.dispatchEvent(new e.Event("stop")):t.eventTarget.dispatchEvent(new e.CustomEvent("dataAvailable",{detail:n.data}))}),this.encodeBuffers=function(){delete this.encodeBuffers},this.state="recording",this.monitorNode.connect(this.audioContext.destination),this.scriptProcessorNode.connect(this.audioContext.destination),this.eventTarget.dispatchEvent(new e.Event("start")),this.encoder.postMessage(this.config)}},t.prototype.stop=function(){"inactive"!==this.state&&(this.state="inactive",this.sourceNode.disconnect(this.scriptProcessorNode),this.sourceNode.disconnect(this.monitorNode),this.monitorNode.disconnect(this.audioContext.destination),this.scriptProcessorNode.disconnect(this.audioContext.destination),this.config.leaveStreamOpen||this.clearStream(),this.encoder.postMessage({command:"done"}))},t.prototype.renderPause=function(){"running"===this.renderState&&(this.renderState="paused",this.eventTarget.dispatchEvent(new e.Event("rpause")))},t.prototype.renderResume=function(){"paused"===this.renderState&&(this.renderState="running",this.eventTarget.dispatchEvent(new e.Event("rresume")))},t.prototype.renderFForward=function(){for(;this.renderQueue.length;)this.renderQueue.shift();this.eventTarget.dispatchEvent(new e.Event("rfforward"))},t.prototype.renderRICounter=function(){this.renderIdleCounter=0,this.eventTarget.dispatchEvent(new e.CustomEvent("ridle",{detail:this.renderIdleCounter}))},t.prototype.feedData=function(e){this.decoder.postMessage({command:"decode",pages:e},[e.buffer])},e.Interceptor=t,"function"==typeof define&&define.amd?define([],function(){return t}):"object"==typeof module&&module.exports&&(module.exports=t)}(root);